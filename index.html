<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cálculo de Splittagem, Potência, Materiais e Mapeamento</title>
    
    <!-- Estilos visuais da página e do simulador -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Estilos da Página */
        body {
            font-family: 'Inter', sans-serif, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1280px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        /* Estilos do Simulador */
        .input-field {
          @apply w-24 text-xs p-1 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out flex-shrink-0;
          text-align: center;
        }
        select.input-field {
          text-align-last: center;
        }
        .result-field {
          @apply w-24 text-center text-xs p-1 border border-gray-200 rounded-md bg-gray-100 font-semibold text-gray-700 flex-shrink-0;
        }
        .loss-detail {
            @apply w-24 text-xs text-center text-red-600 font-medium p-1 flex-shrink-0;
        }
        .signal-good { @apply bg-green-100 border-green-300 text-green-800; }
        .signal-warn { @apply bg-yellow-100 border-yellow-300 text-yellow-800; }
        .signal-bad  { @apply bg-red-100 border-red-300 text-red-800; }

        .top-button {
          @apply bg-white text-gray-700 font-bold py-2 px-4 rounded-lg shadow-lg hover:bg-gray-100 transition flex items-center border border-gray-300;
        }
        .cta-button {
            @apply bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg hover:bg-indigo-700 transition flex items-center justify-center;
        }
        .geo-button {
            @apply mt-2 px-3 py-1 text-xs font-bold rounded-lg shadow-sm transition-colors duration-150;
        }
        .manual-signal-field {
          @apply mt-2 w-full h-8 text-center border-b-2 border-dashed border-gray-400 font-bold text-gray-700;
        }
        .printable-only-description {
            display: none;
        }
        
        /* Estilos das Abas de Navegação */
        .tab-button {
            @apply whitespace-nowrap py-3 px-4 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors duration-200;
        }
        .tab-active {
            @apply border-indigo-500 text-indigo-600;
        }


        @media print {
          body * { visibility: hidden; }
          #print-wrapper, #print-wrapper * { visibility: visible; }
          #print-wrapper { position: absolute; left: 0; top: 0; width: 100%; }
          body { -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size: 9pt; }
          .no-print { display: none !important; }
          .printable-area { box-shadow: none !important; border: none !important; page-break-inside: avoid; }
          #main-title-print, #technician-name-print { display: block !important; }
          h2 { font-size: 1.25rem; }
          #network-layout-container, #balanced-network-container { gap: 0.5rem; }
          .cto-card-print { width: 240px !important; page-break-inside: avoid; }
          .printable-only-description { display: block; margin-top: 0.5rem; text-align: left; }
        }
    </style>
</head>
<body>

    <div class="container">
        
        <div>
    
            <div class="max-w-screen-2xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 no-print">
                    <h1 id="main-title" class="text-3xl md:text-4xl font-extrabold text-gray-800 text-center md:text-left">Cálculo de Splittagem, Potência, Materiais e Mapeamento</h1>
            
                    <div class="flex items-center gap-2 flex-wrap justify-center">
                        <button onclick="shareProject()" title="Compartilhar Projeto" class="cta-button">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
                            </svg>
                            Compartilhar
                        </button>
                        <button onclick="window.print()" title="Imprimir Relatório" class="top-button">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7V9h6v3z" clip-rule="evenodd" /></svg>
                            Imprimir
                        </button>
                        <input type="file" id="file-input" class="hidden" accept=".json" onchange="loadProject(event)">
                        <label for="file-input" title="Abrir um projeto salvo do seu computador" class="top-button cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" /></svg>
                            Abrir
                        </label>
                        <button onclick="saveProject()" title="Salvar o projeto atual como um arquivo .json" class="top-button">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v10a2 2 0 01-2 2H7a2 2 0 01-2-2V4zm3 1a1 1 0 00-1 1v6a1 1 0 102 0V6a1 1 0 00-1-1z" /></svg>
                            Salvar Projeto
                        </button>
                    </div>
                </div>
            
                <div id="print-wrapper">
                    <h1 id="main-title-print" class="text-3xl font-bold text-center mb-2 hidden"></h1>
                    <h3 id="technician-name-print" class="text-xl font-normal text-center text-gray-600 mb-6 hidden"></h3>
            
                    <div class="bg-white p-2 md:p-4 rounded-lg shadow-xl printable-area mb-8">
                      <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Configurações Gerais do Projeto</h2>
                      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-6 justify-items-center">
                        <div class="flex flex-col items-center">
                            <label for="project-name-input" class="font-bold text-lg text-gray-600">Nome do Projeto (Localidade)</label>
                            <input id="project-name-input" oninput="handleProjectNameChange(this.value)" type="text" placeholder="Ex: Bairro Centro" class="mt-1 w-72 text-center p-1 rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500">
                        </div>
                        <div class="flex flex-col items-center">
                            <label for="technician-name-input" class="font-bold text-lg text-gray-600">Técnico(s) Responsável(is)</label>
                            <input id="technician-name-input" oninput="saveTechnicianName(this.value)" type="text" placeholder="Ex: João da Silva" class="mt-1 w-72 text-center p-1 rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500">
                        </div>
                        <div class="flex flex-col items-center">
                            <label for="olt-power-input" class="font-bold text-lg text-gray-600">Potência OLT</label>
                            <div class="flex items-center mt-1">
                                <input type="text" id="olt-power-input" oninput="handleOltPowerChange(this)" class="w-24 text-center p-1 rounded-md text-indigo-900 font-bold border-2 border-gray-300 focus:border-indigo-500"/>
                                <span class="font-semibold text-indigo-700 ml-1">dBm</span>
                            </div>
                        </div>
                        <div class="flex flex-col items-center md:col-span-2 lg:grid-cols-3 w-full max-w-2xl">
                            <label for="map-link-input" class="font-bold text-lg text-gray-600">Link do Mapa do Projeto (Google My Maps)</label>
                            <div class="flex items-center mt-1 w-full">
                                <input id="map-link-input" oninput="handleMapLinkChange(this.value)" type="url" placeholder="Cole o link compartilhável do seu mapa aqui" class="w-full text-center p-1 rounded-l-md font-bold border-2 border-gray-300 focus:border-indigo-500">
                                <button onclick="viewProjectMap()" title="Visualizar Mapa do Projeto" class="bg-blue-600 text-white p-2 rounded-r-md hover:bg-blue-700 transition no-print">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.527-1.912 6.01 6.01 0 012.142 4.072 6.01 6.01 0 01-3.668 5.473 1.503 1.503 0 01-1.499.044 2 2 0 00-2.427 0 2 2 0 01-1.527 1.912 6.01 6.01 0 01-3.8-5.57z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                      </div>
                    </div>
            
                    <div class="bg-white p-4 rounded-lg shadow-xl printable-area mb-8">
                        <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Detalhes da Conexão na OLT</h2>
                        <div class="max-w-4xl mx-auto flex flex-col md:flex-row items-center justify-around gap-8">
                            <div class="flex-shrink-0">
                                <svg class="h-24 w-24 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                                </svg>
                            </div>
                            <div class="w-full flex flex-col md:flex-row gap-6">
                                <div class="flex-1 flex flex-col items-center">
                                    <label for="olt-port-input" class="font-bold text-lg text-gray-600">Porta da OLT</label>
                                    <input id="olt-port-input" oninput="handleOltDetailsChange('oltPortNumber', this.value)" type="text" placeholder="Ex: 0/1/0" class="mt-1 w-full max-w-xs text-center p-1 rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500">
                                </div>
                                <div class="flex-1 flex flex-col items-center">
                                    <label for="dio-group-input" class="font-bold text-lg text-gray-600">Grupo DIO</label>
                                    <input id="dio-group-input" oninput="handleOltDetailsChange('dioGroup', this.value)" type="text" placeholder="Ex: A1" class="mt-1 w-full max-w-xs text-center p-1 rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500">
                                </div>
                                <div class="flex-1 flex flex-col items-center">
                                    <label for="fiber-color-input" class="font-bold text-lg text-gray-600">Cor da Fibra</label>
                                    <input id="fiber-color-input" oninput="handleOltDetailsChange('fiberColor', this.value)" type="text" placeholder="Ex: Verde" class="mt-1 w-full max-w-xs text-center p-1 rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- NAVEGAÇÃO POR ABAS -->
                    <div class="border-b border-gray-200 mb-6 no-print">
                        <nav class="-mb-px flex justify-center space-x-4" aria-label="Tabs">
                            <button id="tab-desbalanceada" onclick="switchTab('desbalanceada')" class="tab-button tab-active">Rede Desbalanceada</button>
                            <button id="tab-balanceada" onclick="switchTab('balanceada')" class="tab-button">Rede Balanceada</button>
                        </nav>
                    </div>

                    <!-- CONTEÚDO DAS ABAS -->
                    <div id="tab-panel-desbalanceada" class="tab-panel">
                        <div class="bg-white p-2 md:p-4 rounded-lg shadow-xl printable-area mb-8">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-center text-gray-700">Parâmetros da Rede Desbalanceada</h2>
                                <button onclick="addCto()" class="top-button no-print">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                    Adicionar CTO
                                </button>
                            </div>
                            <div id="network-layout-container" class="flex flex-wrap justify-center gap-4">
                                <!-- Cards da rede desbalanceada -->
                            </div>
                        </div>
                    </div>

                    <div id="tab-panel-balanceada" class="tab-panel hidden">
                         <div class="bg-white p-2 md:p-4 rounded-lg shadow-xl printable-area mb-8">
                            <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Parâmetros da Rede Balanceada</h2>
                            <!-- Configurações da Rede Balanceada -->
                            <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 p-4 rounded-lg border mb-6">
                                <div class="flex flex-col items-center">
                                    <label for="balanced-primary-splitter" class="font-bold text-lg text-gray-600">Splitter Primário (CEOA)</label>
                                    <select id="balanced-primary-splitter" onchange="handleBalancedConfigChange('primarySplitter', this.value)" class="mt-1 w-full max-w-xs text-center p-1 rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500"></select>
                                </div>
                                <div class="flex flex-col items-center">
                                    <label for="balanced-secondary-splitter" class="font-bold text-lg text-gray-600">Splitter Secundário (CTO)</label>
                                    <select id="balanced-secondary-splitter" onchange="handleBalancedConfigChange('secondarySplitter', this.value)" class="mt-1 w-full max-w-xs text-center p-1 rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500"></select>
                                </div>
                            </div>
                             <div class="flex justify-center mb-6">
                                 <button onclick="addBalancedCto()" class="top-button no-print">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                     Adicionar CTO
                                 </button>
                             </div>
                             <div id="balanced-network-container" class="flex flex-wrap justify-center gap-4">
                                 <!-- Cards da rede balanceada -->
                             </div>
                         </div>
                    </div>

                    <div class="mt-8">
                        <div class="bg-white p-4 rounded-lg shadow-xl printable-area mb-8">
                            <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Lançamentos de Fibra</h2>
                            <div id="fiber-runs-container" class="max-w-4xl mx-auto space-y-4">
                                <!-- Conteúdo dinâmico aqui -->
                            </div>
                            <div class="flex justify-center mt-4">
                                <button onclick="addFiberRun()" class="top-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                    Adicionar Lançamento de Fibra
                                </button>
                            </div>
                        </div>

                        <div class="bg-white p-2 md:p-4 rounded-lg shadow-xl printable-area">
                          <h2 class="text-2xl font-bold text-center text-gray-700 mb-4">Lista de Materiais e Orçamento</h2>
                           <p class="text-center text-sm text-gray-500 mb-4">A lista é calculada com base na aba de rede que está ativa (<span id="active-network-label" class="font-bold"></span>).</p>
                          <div class="max-w-4xl mx-auto">
                            <table class="w-full text-sm" id="materials-table"></table>
                          </div>
                           <div id="materials-calculation-details" class="max-w-4xl mx-auto mt-6">
                               <!-- Content will be injected by JavaScript -->
                           </div>
                        </div>
                    </div>
                </div>
            
                <div id="custom-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
                        <div class="p-6">
                            <h3 class="text-xl font-bold text-gray-800 text-left" id="modal-title"></h3>
                            <div class="mt-4">
                                <p class="text-md text-gray-600 text-left whitespace-pre-line" id="modal-content"></p>
                            </div>
                        </div>
                        <div class="bg-gray-100 px-6 py-4 flex justify-end gap-3 rounded-b-lg">
                            <button id="cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 hidden">
                                Cancelar
                            </button>
                            <button id="ok-btn" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                OK
                            </button>
                        </div>
                    </div>
                </div>
            
                <div id="description-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
                        <div class="p-6 text-left">
                            <h3 class="text-xl font-bold text-gray-800">Descrição do Sinal</h3>
                            <div class="mt-4">
                                <label for="signal-description-input" class="block text-sm font-medium text-gray-700">Adicione uma nota sobre o sinal medido:</label>
                                <textarea id="signal-description-input" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                            </div>
                        </div>
                        <div class="bg-gray-100 px-6 py-4 flex justify-end gap-3 rounded-b-lg">
                            <button id="close-description-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">
                                Cancelar
                            </button>
                             <button id="save-description-btn" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                Salvar
                            </button>
                        </div>
                    </div>
                </div>
            
              </div>

        </div>

    </div>

    <script id="main-logic-script">
        // Variáveis de Estado Globais
        let oltPower = 7.00;
        let projectName = '';
        let technicianName = '';
        let googleMapsUrl = '';
        let oltPortNumber = '';
        let dioGroup = '';
        let fiberColor = '';
        let fiberRuns = [{ type: 'Fibra Óptica 12 FO', length: 0 }];
        let manualMaterials = {};
        let materialPrices = {};
        let activeTab = 'desbalanceada';
        
        // Estado para a Rede Desbalanceada
        let networkSegments = [
            { splitterHub: 'Ausente', splitterCto: 'Ausente', distance: 0, spliceCount: 0, geo: null, description: '', colorGroup: 0 }
        ];

        // Estado para a Rede Balanceada
        let balancedConfig = { primarySplitter: '1:8', secondarySplitter: '1:8' };
        let balancedNetworkCtos = [
            { distance: 0, spliceCount: 0, geo: null, description: '', colorGroup: 0 }
        ];

        const FIBER_LOSS_PER_KM = 0.10;
        const FUSION_SPLICE_LOSS = 0.10;
        let debounceTimer = null;

        const FIBER_COLORS = [
            { name: 'Verde', hex: '#28a745', text: 'white' }, { name: 'Amarelo', hex: '#ffc107', text: 'black' },
            { name: 'Branco', hex: '#ffffff', text: 'black' }, { name: 'Azul', hex: '#007bff', text: 'white' },
            { name: 'Vermelho', hex: '#dc3545', text: 'white' }, { name: 'Violeta', hex: '#6f42c1', text: 'white' },
            { name: 'Marrom', hex: '#a52a2a', text: 'white' }, { name: 'Rosa', hex: '#e83e8c', text: 'white' },
            { name: 'Preto', hex: '#000000', text: 'white' }, { name: 'Cinza', hex: '#6c757d', text: 'white' },
            { name: 'Laranja', hex: '#fd7e14', text: 'white' }, { name: 'Aqua', hex: '#00ffff', text: 'black' }
        ];
    
        const UNBALANCED_PARAMETER_ROWS = [
          { label: 'Sinal Entrada', key: 'sinalEntradaHub', type: 'result' },
          { label: 'Splitter Desb.', key: 'splitterHub', type: 'select_hub' },
          { label: 'Perda Passagem', key: 'perdaPassagemHub', type: 'result_detail' },
          { label: 'Sinal Saída', key: 'sinalSaidaHub', type: 'result' },
          { label: 'Perda Trecho', key: 'perdaTotalTrecho', type: 'result_detail' },
          { label: 'Splitter CTO', key: 'splitterCto', type: 'select_cto' },
          { label: 'Sinal Final CTO', key: 'sinalFinalCto', type: 'result_final' },
        ];
        
        const splitterLosses = { 
          'Ausente': { drop: 0, pass: 0 }, '1:2': { drop: 3.7 }, '1:4': { drop: 7.1 }, '1:8': { drop: 10.5 }, '1:16': { drop: 13.7 }, '1:32': { drop: 17.1 }, '1:64': { drop: 20.4 }, '1:128': { drop: 23.9 }, '1:99': { drop: 21.6, pass: 0.3 }, '2:98': { drop: 18.7, pass: 0.4 }, '4:96': { drop: 14.9, pass: 0.4 }, '5:95': { drop: 14.6, pass: 0.5 }, '7:93': { drop: 13.0, pass: 0.6 }, '10:90': { drop: 11.0, pass: 0.7 }, '15:85': { drop: 9.6,  pass: 1.0 }, '20:80': { drop: 7.9,  pass: 1.4 }, '25:75': { drop: 6.95, pass: 1.7 }, '30:70': { drop: 6.0,  pass: 1.9 }, '35:65': { drop: 5.35, pass: 2.3 }, '40:60': { drop: 4.7,  pass: 2.7 }, '45:55': { drop: 4.15, pass: 3.15 }, '50:50': { drop: 3.7,  pass: 2.5 },
        };
        
        function getSignalColorClass(signal) { if (isNaN(signal) || signal === null) return 'bg-gray-100 border-gray-300 text-gray-500'; if (signal < -22) return 'signal-bad'; if (signal < -19) return 'signal-warn'; return 'signal-good'; }
        
        function getSplitterOptions(type, selectedValue) { 
            let list;
            if (type === 'hub') {
                list = Object.keys(splitterLosses).filter(k => splitterLosses[k].pass !== undefined);
            } else if (type === 'balanced') {
                list = Object.keys(splitterLosses).filter(k => splitterLosses[k].pass === undefined && k !== 'Ausente');
            } else { // cto
                list = Object.keys(splitterLosses).filter(k => splitterLosses[k].pass === undefined || k === 'Ausente');
            }
            return list.map(key => `<option value="${key}" ${key === selectedValue ? 'selected' : ''}>${key}</option>`).join('');
        }

        function switchTab(tabName) {
            activeTab = tabName;

            const tabs = ['desbalanceada', 'balanceada'];
            tabs.forEach(tab => {
                document.getElementById(`tab-panel-${tab}`).classList.add('hidden');
                document.getElementById(`tab-${tab}`).classList.remove('tab-active');
            });

            // Mostra o painel selecionado e ativa o botão
            document.getElementById(`tab-panel-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');
            
            updateMaterialsList();
        }
        
        function showModal(title, content, isConfirm = false, onConfirm = null) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-content').innerText = content;
            const okBtn = document.getElementById('ok-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            
            okBtn.onclick = () => { modal.classList.add('hidden'); if (onConfirm) onConfirm(); };
            cancelBtn.onclick = () => { modal.classList.add('hidden'); };
    
            cancelBtn.classList.toggle('hidden', !isConfirm);
            if (isConfirm) {
                okBtn.onclick = () => { modal.classList.add('hidden'); if (onConfirm) onConfirm(true); };
                cancelBtn.onclick = () => { modal.classList.add('hidden'); if (onConfirm) onConfirm(false); };
            }
            modal.classList.remove('hidden');
        }
    
        let currentCtoInfo = null;
        function showDescriptionModal(index, networkType) {
            currentCtoInfo = { index, networkType };
            const modal = document.getElementById('description-modal');
            const descriptionInput = document.getElementById('signal-description-input');
            const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
            descriptionInput.value = network[index].description || '';

            document.getElementById('save-description-btn').onclick = () => {
                if (currentCtoInfo !== null) {
                    const { index, networkType } = currentCtoInfo;
                    const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
                    network[index].description = descriptionInput.value;
                    modal.classList.add('hidden');
                    showModal("Descrição Salva", "A descrição do sinal foi salva com sucesso.", false, () => {
                         if (networkType === 'unbalanced') renderUnbalancedNetwork();
                         else renderBalancedNetwork();
                    });
                } else {
                   modal.classList.add('hidden');
                }
            };
            document.getElementById('close-description-btn').onclick = () => { modal.classList.add('hidden'); };
            modal.classList.remove('hidden');
        }
    
        function renderUnbalancedNetwork() {
            const container = document.getElementById('network-layout-container');
            container.innerHTML = ''; 

            networkSegments.forEach((segment, index) => {
                const ctoCard = createCtoCard(segment, index, 'unbalanced');
                container.appendChild(ctoCard);
            });
        }
        
        function renderBalancedNetwork() {
            const container = document.getElementById('balanced-network-container');
            container.innerHTML = '';
            
            document.getElementById('balanced-primary-splitter').innerHTML = getSplitterOptions('balanced', balancedConfig.primarySplitter);
            document.getElementById('balanced-secondary-splitter').innerHTML = getSplitterOptions('balanced', balancedConfig.secondarySplitter);

            balancedNetworkCtos.forEach((cto, index) => {
                const ctoCard = createCtoCard(cto, index, 'balanced');
                container.appendChild(ctoCard);
            });
        }

        function createCtoCard(data, index, networkType) {
            const isUnbalanced = networkType === 'unbalanced';
            const geoText = data.geo ? `${data.geo.lat.toFixed(5)}, ${data.geo.lon.toFixed(5)}` : 'N/A';
            const cardIdPrefix = isUnbalanced ? 'U' : 'B';
            const title = isUnbalanced ? `CTO-${String(index + 1).padStart(2, '0')}` : `CTO Bal.-${String(index + 1).padStart(2, '0')}`;
            const selectedColor = FIBER_COLORS[data.colorGroup || 0];
            
            const ctoCard = document.createElement('div');
            ctoCard.className = "cto-card-print flex flex-col items-center bg-gray-50 rounded-lg shadow-md border p-3";
            ctoCard.style.width = "280px";
            
            let cardHtml = `
            <h3 class="relative text-lg font-bold mb-3 px-4 py-1 rounded-full border border-gray-300" 
                 style="background-color:${selectedColor.hex}; color:${selectedColor.text};">
                ${title}
                <button onclick="${isUnbalanced ? 'removeCto' : 'removeBalancedCto'}(${index})" title="Remover CTO" class="absolute -top-2 -right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors no-print"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </h3>
            <div class="flex flex-col items-center mb-2 w-full">
                <span class="text-xs font-semibold text-gray-600">Geolocalização:</span>
                <span class="text-xs text-gray-500 mt-1 printable-geo">${geoText}</span>
                <div class="flex gap-2 mt-1">
                    <button onclick="getGeoLocation(${index}, '${networkType}')" class="geo-button bg-blue-500 text-white hover:bg-blue-600 no-print flex-1 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg> GPS</button>
                    <button onclick="copyGeoLocation(${index}, '${networkType}')" class="geo-button bg-gray-500 text-white hover:bg-gray-600 no-print flex-1 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg> Copiar</button>
                </div>
                <div class="flex items-center mt-2 w-full">
                    <input id="manual-geo-input-${cardIdPrefix}-${index}" type="text" placeholder="Inserir Coords." class="w-full text-center text-xs p-1 rounded-l-md border-2 border-gray-300 focus:border-indigo-500">
                    <button onclick="saveManualGeo(${index}, '${networkType}')" class="bg-indigo-500 text-white text-xs font-bold p-1.5 rounded-r-md hover:bg-indigo-600 transition">Salvar</button>
                </div>
            </div>
            <div class="flex items-center w-full mb-1.5 px-2">
                <label class="flex-1 text-xs font-semibold text-gray-600">Distancia (m):</label>
                <input id="cto-${cardIdPrefix}-${index}-distance" type="number" value="${data.distance || 0}" oninput="handleCtoDataChange(event, ${index}, '${networkType}', 'distance')" class="input-field" />
            </div>
            <div class="flex items-center w-full mb-1.5 px-2">
                <label class="flex-1 text-xs font-semibold text-gray-600">Nº de Fusões:</label>
                <input id="cto-${cardIdPrefix}-${index}-spliceCount" type="number" value="${data.spliceCount || 0}" oninput="handleCtoDataChange(event, ${index}, '${networkType}', 'spliceCount')" class="input-field" />
            </div>`;
            
            cardHtml += `<div class="flex items-center w-full mb-1.5 px-2">
                <label class="flex-1 text-xs font-semibold text-gray-600">Cor da Fibra:</label>
                <select id="cto-${cardIdPrefix}-${index}-colorGroup" oninput="handleCtoDataChange(event, ${index}, '${networkType}', 'colorGroup')" class="input-field font-semibold" style="background-color:${selectedColor.hex}; color:${selectedColor.text}; border-color: #999;">
                    ${FIBER_COLORS.map((color, colorIndex) => `<option value="${colorIndex}" ${colorIndex === (data.colorGroup || 0) ? 'selected' : ''} style="background-color:${color.hex}; color:${color.text};">${colorIndex + 1} - ${color.name}</option>`).join('')}
                </select>
            </div>`;

            cardHtml += `<div class="w-full">`;
            
            const parameterRows = isUnbalanced ? UNBALANCED_PARAMETER_ROWS : [{ label: 'Sinal Final CTO', key: 'sinalFinal', type: 'result_final' }];
            
            parameterRows.forEach(row => {
                const value = data[row.key];
                cardHtml += `<div class="flex items-center w-full mb-1.5 px-2"><label class="flex-1 text-xs font-semibold text-gray-600">${row.label}:</label>`;
                switch(row.type) {
                    case 'select_hub': cardHtml += `<select id="cto-${cardIdPrefix}-${index}-splitterHub" oninput="handleCtoDataChange(event, ${index}, '${networkType}', 'splitterHub')" class="input-field">${getSplitterOptions('hub', data.splitterHub)}</select>`; break;
                    case 'select_cto': cardHtml += `<select id="cto-${cardIdPrefix}-${index}-splitterCto" oninput="handleCtoDataChange(event, ${index}, '${networkType}', 'splitterCto')" class="input-field">${getSplitterOptions('cto', data.splitterCto)}</select>`; break;
                    case 'result': cardHtml += `<input type="text" value="${value || '---'}" readonly class="result-field" />`; break;
                    case 'result_detail': cardHtml += `<div class="loss-detail">${value || '---'}</div>`; break;
                    case 'result_final':
                        const finalSignal = parseFloat(value);
                        const colorClass = getSignalColorClass(finalSignal);
                        cardHtml = cardHtml.slice(0, -57);
                        cardHtml += `<div class="flex justify-between items-center w-full mb-1.5 px-2"><label class="text-xs font-semibold text-gray-600">${row.label}:</label><div class="px-3 py-1 text-sm font-bold rounded-full ${colorClass}">${value || '---'}</div></div>`;
                        break;
                }
                if (row.type !== 'result_final') { cardHtml += `</div>`; }
            });
            
            cardHtml += `<div class="mt-2 w-full text-center text-xs text-gray-500 font-bold no-print flex items-center justify-between"><span>Sinal Medido em Campo</span><button onclick="showDescriptionModal(${index}, '${networkType}')" class="p-1 rounded-full text-white bg-gray-500 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400" title="Adicionar/Editar Descrição"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button></div><div class="manual-signal-field no-print"><span class="text-xs text-gray-500 italic">${data.description || 'Nenhuma descrição salva.'}</span></div><div class="printable-only-description"><span class="text-xs font-bold text-gray-700">Descrição: </span><span>${data.description || 'N/A'}</span></div></div>`;
            ctoCard.innerHTML = cardHtml;
            return ctoCard;
        }
    
        function updateMaterialsList() {
            document.getElementById('active-network-label').textContent = activeTab === 'desbalanceada' ? 'Desbalanceada' : 'Balanceada';
            const table = document.getElementById('materials-table');
            let html = `<thead class="bg-gray-100"><tr><th class="py-2 px-4 text-left">Item</th><th class="py-2 px-4 text-center">Valor Unit.</th><th class="py-2 px-4 text-center">Qtde.</th><th class="py-2 px-4 text-right">Subtotal</th></tr></thead><tbody>`;
            let grandTotal = 0;
            
            let ctoCount = 0;
            const hubSplitterCounts = {}, ctoSplitterCounts = {};
            let totalAcopladores = 0;

            if (activeTab === 'desbalanceada') {
                const activeSegments = networkSegments.filter(seg => seg.splitterHub !== 'Ausente');
                ctoCount = activeSegments.length;
                activeSegments.forEach(seg => {
                    if (seg.splitterHub) { hubSplitterCounts[seg.splitterHub] = (hubSplitterCounts[seg.splitterHub] || 0) + 1; }
                    if (seg.splitterCto && seg.splitterCto !== 'Ausente') { 
                        ctoSplitterCounts[seg.splitterCto] = (ctoSplitterCounts[seg.splitterCto] || 0) + 1; 
                        const parts = seg.splitterCto.split(':');
                        if (parts.length === 2) { totalAcopladores += parseInt(parts[1], 10) || 0; }
                    }
                });
            } else { // Rede Balanceada
                ctoCount = balancedNetworkCtos.length;
                if (balancedConfig.primarySplitter) {
                     hubSplitterCounts[balancedConfig.primarySplitter] = 1;
                }
                if (balancedConfig.secondarySplitter) {
                    ctoSplitterCounts[balancedConfig.secondarySplitter] = ctoCount;
                    const parts = balancedConfig.secondarySplitter.split(':');
                    if (parts.length === 2) { totalAcopladores += (parseInt(parts[1], 10) || 0) * ctoCount; }
                }
            }
            
            const fiberTotals = {};
            fiberRuns.forEach(run => {
                if (!fiberTotals[run.type]) {
                    fiberTotals[run.type] = 0;
                }
                fiberTotals[run.type] += run.length || 0;
            });

            const fiberMaterialItems = Object.keys(fiberTotals).map(type => {
                const totalLength = fiberTotals[type];
                return {
                    id: `cabo_${type.replace(/[^a-z0-9]/gi, '_')}`,
                    name: `${type} (Lançada)`,
                    qty: `${totalLength} m`,
                    numericQty: totalLength,
                    editable: false,
                };
            });

            const poleCount = fiberRuns.reduce((sum, run) => sum + run.length, 0) > 0 ? Math.ceil(fiberRuns.reduce((sum, run) => sum + run.length, 0) / 43) : 0;

            const otherMaterials = [
                { id: 'cto_total', name: 'Total de CTOs', qty: ctoCount, numericQty: ctoCount, editable: false }, 
                ...Object.entries(hubSplitterCounts).map(([name, count]) => ({ id: `hub_${name.replace(/[^a-zA-Z0-9]/g, '')}`, name: `Splitter ${activeTab === 'balanceada' ? 'Primário' : 'Desb.'} ${name}`, qty: count, numericQty: count, editable: false })), 
                ...Object.entries(ctoSplitterCounts).map(([name, count]) => ({ id: `cto_${name.replace(/[^a-zA-Z0-9]/g, '')}`, name: `Splitter de CTO ${name}`, qty: count, numericQty: count, editable: false })), 
                { id: 'acoplador', name: 'Acoplador Óptico SC/APC', qty: totalAcopladores, numericQty: totalAcopladores, editable: false },
                { id: 'bap', name: 'Braçadeira BAP', qty: poleCount, numericQty: poleCount, editable: true }, 
                { id: 'supa', name: 'Suporte (SUPA)', qty: poleCount, numericQty: poleCount, editable: true }, 
                { id: 'alca', name: 'Alça Preformada', qty: poleCount * 2, numericQty: poleCount * 2, editable: true }, 
                { id: 'caixa_emenda', name: 'Caixa de Emenda Óptica (Adicional)', qty: 0, numericQty: 0, editable: true, manual: true }, 
                { id: 'arame', name: 'Arame de Espinar (m)', qty: 0, numericQty: 0, editable: true, manual: true }, 
                { id: 'roldana', name: 'Roldana', qty: 0, numericQty: 0, editable: true, manual: true }
            ];
            
            const allMaterials = [...fiberMaterialItems, ...otherMaterials];

            allMaterials.forEach(item => {
                const unitPrice = materialPrices[item.id] || 0;
                let itemQty = item.editable ? (manualMaterials[item.id] !== undefined ? parseInt(manualMaterials[item.id], 10) || 0 : item.numericQty) : item.numericQty;
                
                 if(item.manual) itemQty = manualMaterials[item.id] || 0;
                
                const subtotal = itemQty * unitPrice;
                grandTotal += subtotal;

                const qtyDisplay = item.qty.toString().includes('m') ? item.qty : itemQty;

                html += `<tr class="border-b">
                    <td class="py-2 px-4 font-semibold align-middle">${item.name}</td>
                    <td class="py-2 px-4 align-middle">
                        <input type="text" id="price-${item.id}" oninput="saveMaterialPrice(event, '${item.id}', this.value)" value="${unitPrice > 0 ? unitPrice.toFixed(2).replace('.', ',') : ''}" placeholder="0,00" class="w-24 text-center font-bold p-1 border rounded bg-gray-50 focus:bg-white">
                    </td>
                    <td class="py-2 px-4 text-center align-middle">`;

                if (item.editable) {
                    const onInputHandler = `oninput="saveManualMaterial(event, '${item.id}', this.value)"`;
                    let qtyValue = manualMaterials[item.id] !== undefined ? manualMaterials[item.id] : item.qty;
                     if(item.manual) qtyValue = manualMaterials[item.id] || 0;

                    html += `<input type="number" id="input-${item.id}" value="${qtyValue}" ${onInputHandler} class="w-20 text-center font-bold p-1 border rounded bg-gray-50 focus:bg-white">`;
                } else {
                    html += `<span class="font-bold text-lg">${qtyDisplay}</span>`;
                }
                
                html += `</td>
                    <td class="py-2 px-4 text-right align-middle font-bold">${subtotal.toFixed(2).replace('.',',')}</td>
                </tr>`;
            });
            html += `</tbody>
                <tfoot class="bg-gray-100 font-bold">
                    <tr>
                        <td colspan="3" class="py-3 px-4 text-right text-lg">Custo Total:</td>
                        <td class="py-3 px-4 text-right text-lg">${grandTotal.toFixed(2).replace('.',',')}</td>
                    </tr>
                </tfoot>`;
            table.innerHTML = html;

            const detailsContainer = document.getElementById('materials-calculation-details');
            detailsContainer.innerHTML = `
                <h3 class="text-xl font-bold text-center text-gray-700 mb-4 border-t pt-4">Memória de Cálculo</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 text-sm bg-gray-50 p-4 rounded-lg">
                    <div class="flex justify-between border-b pb-1">
                        <span class="font-semibold text-gray-600">Total de Fibra Lançada:</span>
                        <span class="font-bold text-gray-800">${fiberRuns.reduce((sum, run) => sum + run.length, 0).toFixed(0)} m</span>
                    </div>
                    <div class="flex justify-between border-b pb-1">
                        <span class="font-semibold text-gray-600">Total de Postes (1 a cada 43m):</span>
                        <span class="font-bold text-gray-800">${poleCount}</span>
                    </div>
                    <div class="flex justify-between border-b pb-1 md:col-span-2">
                        <span class="font-semibold text-gray-600">Folga de Segurança (5% por tipo de cabo):</span>
                        <span class="font-bold text-gray-800">Calculado individualmente</span>
                    </div>
                </div>
            `;
        }
    
        function recalculateUnbalanced() {
            let powerForNextSegment = oltPower;
            let isPathBroken = false;
            networkSegments.forEach((segment) => {
                if (isPathBroken) {
                     Object.assign(segment, { sinalEntradaHub: null, perdaPassagemHub: null, sinalSaidaHub: null, perdaTotalTrecho: null, sinalFinalCto: null });
                     return;
                }
                const distanceInKm = (segment.distance || 0) / 1000;
                const fusionLoss = (segment.spliceCount || 0) * FUSION_SPLICE_LOSS;
                const totalSegmentLoss = (distanceInKm * FIBER_LOSS_PER_KM) + fusionLoss;
                segment.perdaTotalTrecho = totalSegmentLoss.toFixed(2) + ' dB';

                const sinalEntradaHub = powerForNextSegment - totalSegmentLoss;
                segment.sinalEntradaHub = sinalEntradaHub.toFixed(2);
                
                const hubSplitter = splitterLosses[segment.splitterHub] || { drop: 0, pass: 0 };
                const ctoSplitter = splitterLosses[segment.splitterCto] || { drop: 0 };
                
                segment.perdaPassagemHub = (hubSplitter.pass || 0).toFixed(2) + ' dB';
                
                const sinalFinalCto = sinalEntradaHub - hubSplitter.drop - ctoSplitter.drop;
                segment.sinalFinalCto = (segment.splitterCto === 'Ausente') ? null : sinalFinalCto.toFixed(2);
                
                const sinalSaidaHub = sinalEntradaHub - hubSplitter.pass;
                segment.sinalSaidaHub = sinalSaidaHub.toFixed(2);
                
                powerForNextSegment = sinalSaidaHub;
                
                if (segment.splitterHub === 'Ausente' || isNaN(sinalSaidaHub)) {
                    isPathBroken = true;
                    segment.sinalSaidaHub = null;
                    segment.perdaPassagemHub = null;
                }
            });
            renderUnbalancedNetwork();
            updateMaterialsList();
        }

        function recalculateBalanced() {
            const primaryLoss = splitterLosses[balancedConfig.primarySplitter]?.drop || 0;
            const secondaryLoss = splitterLosses[balancedConfig.secondarySplitter]?.drop || 0;
            const powerAfterPrimary = oltPower - primaryLoss;

            balancedNetworkCtos.forEach(cto => {
                const distanceLoss = ((cto.distance || 0) / 1000) * FIBER_LOSS_PER_KM;
                const spliceLoss = (cto.spliceCount || 0) * FUSION_SPLICE_LOSS;
                const totalLoss = distanceLoss + spliceLoss + secondaryLoss;
                const finalSignal = powerAfterPrimary - totalLoss;
                cto.sinalFinal = finalSignal.toFixed(2);
            });
            renderBalancedNetwork();
            updateMaterialsList();
        }
        
        function updateUIWithLoadedData() {
            document.getElementById('project-name-input').value = projectName;
            document.getElementById('technician-name-input').value = technicianName;
            document.getElementById('olt-power-input').value = oltPower.toFixed(2);
            document.getElementById('map-link-input').value = googleMapsUrl;
            document.getElementById('olt-port-input').value = oltPortNumber;
            document.getElementById('dio-group-input').value = dioGroup;
            document.getElementById('fiber-color-input').value = fiberColor;
            
            renderFiberRuns();
            recalculateUnbalanced();
            recalculateBalanced();
    
            handleProjectNameChange(projectName);
            saveTechnicianName(technicianName);
        }
        
        function handleProjectNameChange(name) {
            document.title = name.trim() ? name.trim() : 'Cálculo de Splittagem, Potência, Materiais e Mapeamento';
            projectName = name.trim();
            document.getElementById('main-title').innerText = projectName ? `Projeto: ${projectName}` : 'Cálculo de Splittagem, Potência, Materiais e Mapeamento';
            document.getElementById('main-title-print').innerText = projectName ? `Projeto: ${projectName}` : 'Relatório de Projeto Óptico';
        }
    
        function handleOltPowerChange(inputElement) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const newValue = parseFloat(inputElement.value.replace(',', '.'));
                if (!isNaN(newValue)) {
                    oltPower = newValue;
                    recalculateUnbalanced();
                    recalculateBalanced();
                }
            }, 500);
        }
    
        function handleCtoDataChange(event, index, networkType, field) {
             const focusedElementId = event.target.id;
             const selectionStart = event.target.selectionStart;
             clearTimeout(debounceTimer);
             debounceTimer = setTimeout(() => {
                const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
                let value = event.target.value;

                if (field === 'distance' || field === 'spliceCount' || field === 'colorGroup') {
                    value = parseFloat(value) || 0;
                }
                 
                if (network[index]) { 
                    network[index][field] = value; 
                }
                
                if (networkType === 'unbalanced' && field === 'splitterCto') {
                    // This was the part causing the issue. Now it is removed.
                }

                if (networkType === 'unbalanced') recalculateUnbalanced();
                else recalculateBalanced();
                
                const focusedElement = document.getElementById(focusedElementId);
                if (focusedElement) {
                    focusedElement.focus({ preventScroll: true });
                    if (focusedElement.setSelectionRange) {
                        focusedElement.setSelectionRange(selectionStart, selectionStart);
                    }
                }

             }, 500);
        }

        function handleBalancedConfigChange(field, value) {
            balancedConfig[field] = value;
            recalculateBalanced();
        }

        function handleOltDetailsChange(field, value) {
            if (field === 'oltPortNumber') oltPortNumber = value;
            if (field === 'dioGroup') dioGroup = value;
            if (field === 'fiberColor') fiberColor = value;
        }

        function handleMapLinkChange(url) {
            googleMapsUrl = url.trim();
        }

        function viewProjectMap() {
            if (googleMapsUrl && googleMapsUrl.trim() !== '') {
                try {
                    new URL(googleMapsUrl);
                    window.open(googleMapsUrl, '_blank');
                } catch (e) {
                    showModal("URL Inválida", "Por favor, insira um link válido começando com http:// ou https://", false);
                }
            } else {
                showModal("Nenhum Mapa Definido", "Por favor, insira um link do Google My Maps no campo correspondente.", false);
            }
        }
        
        function saveTechnicianName(name) {
            technicianName = name;
            const printElement = document.getElementById('technician-name-print');
            printElement.innerHTML = name.trim() ? `Técnico(s) Responsável(is): <span class="font-bold">${name}</span>` : '';
        }

        function copyGeoLocation(index, networkType) {
            const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
            const segment = network[index];
            if (segment && segment.geo) {
                const geoString = `${segment.geo.lat}, ${segment.geo.lon}`;
                const textArea = document.createElement("textarea");
                textArea.value = geoString;
                textArea.style.position = "fixed"; 
                textArea.style.top = "-9999px";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showModal("Coordenadas Copiadas", `O texto "${geoString}" foi copiado para a área de transferência.`, false);
                } catch (err) {
                    showModal("Erro ao Copiar", "Não foi possível copiar as coordenadas.", false);
                }
                document.body.removeChild(textArea);
            } else {
                showModal("Geolocalização Ausente", "Primeiro, clique em 'GPS' para capturar as coordenadas.", false);
            }
        }
    
        function getGeoLocation(index, networkType) {
            if (!navigator.geolocation) {
                showModal("Geolocalização Não Suportada", "Seu navegador não suporta a API de Geolocalização.", false);
                return;
            }
            
            if (window.isSecureContext === false) {
                 showModal("Conexão Insegura", "O GPS não pode ser ativado em conexões não seguras (HTTP ou local). Por favor, hospede o arquivo em um servidor com HTTPS para usar esta funcionalidade.", false);
                 return;
            }

            showModal("Obtendo localização...", "Por favor, aguarde enquanto o GPS está sendo capturado.\n\nPode ser necessário autorizar o acesso à sua localização no navegador.", false);
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    network[index].geo = { lat: lat, lon: lon };
                    showModal("Localização Capturada!", `As coordenadas ${lat.toFixed(5)}, ${lon.toFixed(5)} foram salvas.`, false);
                    if (networkType === 'unbalanced') renderUnbalancedNetwork();
                    else renderBalancedNetwork();
                },
                (error) => {
                    let message = "Ocorreu um erro desconhecido.";
                    if (error.code === 1) { // PERMISSION_DENIED
                         message = "Permissão de acesso ao GPS foi negada.\n\nVerifique as permissões do seu navegador para este site. Lembre-se que o GPS só funciona em conexões seguras (HTTPS).";
                    } else if (error.code === 2) { // POSITION_UNAVAILABLE
                         message = "Localização indisponível. Não foi possível obter a sua posição atual.";
                    } else if (error.code === 3) { // TIMEOUT
                         message = "Tempo esgotado ao tentar obter a localização.";
                    }
                    showModal("Erro de Geolocalização", message, false);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
        
        function saveManualGeo(index, networkType) {
            const cardIdPrefix = networkType === 'unbalanced' ? 'U' : 'B';
            const input = document.getElementById(`manual-geo-input-${cardIdPrefix}-${index}`);
            const coordsString = input.value.trim();
            if (coordsString) {
                const parts = coordsString.replace(/ /g, '').split(',');
                if (parts.length === 2) {
                    const lat = parseFloat(parts[0]);
                    const lon = parseFloat(parts[1]);
                    if (!isNaN(lat) && !isNaN(lon)) {
                        const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
                        network[index].geo = { lat, lon };
                        if (networkType === 'unbalanced') renderUnbalancedNetwork();
                        else renderBalancedNetwork();
                        showModal("Coordenadas Salvas", `As coordenadas ${lat}, ${lon} foram salvas com sucesso.`, false);
                        input.value = '';
                        return;
                    }
                }
            }
            showModal("Formato Inválido", "Por favor, insira as coordenadas no formato 'latitude, longitude'. Ex: -12.345, -39.876", false);
        }

        async function shareProject() {
            let message = `*Relatório do Projeto Óptico: ${projectName || 'Não Definido'}*\n\n`;
            message += `*Técnico(s):* ${technicianName || 'N/A'}\n`;
            message += `*Potência OLT:* ${oltPower.toFixed(2)} dBm\n`;
            if (googleMapsUrl) {
                message += `*Link do Mapa:* ${googleMapsUrl}\n`;
            }
            message += `\n`;
            
            const grandTotalElement = document.querySelector('#materials-table tfoot tr td:last-child');
            if (grandTotalElement) {
                message += `*Custo Total Estimado:* ${grandTotalElement.textContent}\n\n`;
            }
            
            message += `--- *SIMULAÇÃO REDE BALANCEADA* ---\n`;
            message += `Splitter Primário: ${balancedConfig.primarySplitter}\n`;
            message += `Splitter Secundário: ${balancedConfig.secondarySplitter}\n\n`;
            balancedNetworkCtos.forEach((cto, index) => {
                message += `*CTO Bal.-${String(index + 1).padStart(2, '0')}*\n`;
                message += `Dist.: ${cto.distance || 0}m, Fusões: ${cto.spliceCount || 0}\n`;
                message += `*Sinal Final Estimado:* ${cto.sinalFinal} dBm\n\n`;
            });

            message += `--- *SIMULAÇÃO REDE DESBALANCEADA* ---\n\n`;
            networkSegments.forEach((segment, index) => {
                if (segment.splitterHub !== 'Ausente') {
                    const colorInfo = FIBER_COLORS[segment.colorGroup || 0];
                    message += `*CTO-${String(index + 1).padStart(2, '0')} (${colorInfo.name})*\n`;
                    message += `Dist.: ${segment.distance || 0}m, Fusões: ${segment.spliceCount || 0}\n`;
                    message += `Sinal Entrada: ${segment.sinalEntradaHub} dBm\n`;
                    message += `Splitter Desb.: ${segment.splitterHub}\n`;
                    message += `Sinal Saída: ${segment.sinalSaidaHub} dBm\n`;
                    message += `Splitter CTO: ${segment.splitterCto}\n`;
                    message += `*Sinal Final CTO:* ${segment.sinalFinalCto || '---'} dBm\n`;
                    if (segment.geo) { message += `GPS: https://www.google.com/maps?q=${segment.geo.lat.toFixed(5)},${segment.geo.lon.toFixed(5)}\n`; }
                    message += `\n`;
                }
            });

            const shareData = { title: `Projeto: ${projectName || 'Simulador Óptico'}`, text: message };
            if (navigator.share) {
                try { await navigator.share(shareData); } catch (err) { console.error('Erro ao compartilhar:', err); }
            } else {
                showModal('Compartilhamento Indisponível', 'Seu navegador não suporta a função de compartilhamento. Você pode copiar o texto manualmente.', false);
            }
        }
        
        function saveProject() {
            const projectData = { 
                version: "4.3", projectName, technicianName, oltPower, googleMapsUrl,
                oltPortNumber, dioGroup, fiberColor, fiberRuns, 
                networkSegments, balancedConfig, balancedNetworkCtos, manualMaterials, materialPrices 
            };
            const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = Object.assign(document.createElement('a'), {
                href: url,
                download: `${projectName.replace(/[^a-z0-9]/gi, '_') || 'projeto_sem_nome'}.json`
            });
            document.body.appendChild(a).click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showModal("Projeto Salvo", `Projeto "${projectName || 'projeto_sem_nome'}" salvo com sucesso!`, false);
        }
    
        function loadProject(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    projectName = data.projectName || '';
                    technicianName = data.technicianName || '';
                    oltPower = data.oltPower || 7.00;
                    googleMapsUrl = data.googleMapsUrl || '';
                    oltPortNumber = data.oltPortNumber || '';
                    dioGroup = data.dioGroup || '';
                    fiberColor = data.fiberColor || '';
                    fiberRuns = data.fiberRuns || [{ type: 'Fibra Óptica 12 FO', length: 0 }];
                    networkSegments = data.networkSegments || [{ splitterHub: 'Ausente', splitterCto: 'Ausente', distance: 0, spliceCount: 0, geo: null, description: '', colorGroup: 0 }];
                    balancedConfig = data.balancedConfig || { primarySplitter: '1:8', secondarySplitter: '1:8' };
                    balancedNetworkCtos = data.balancedNetworkCtos || [{ distance: 0, spliceCount: 0, geo: null, description: '', colorGroup: 0 }];
                    manualMaterials = data.manualMaterials || {};
                    materialPrices = data.materialPrices || {};

                    event.target.value = '';
                    updateUIWithLoadedData();
                    showModal("Projeto Carregado", `Projeto "${projectName}" carregado com sucesso!`, false);
                } catch (error) {
                    showModal("Erro ao Carregar", "O arquivo do projeto pode estar corrompido ou em formato inválido.", false);
                }
            };
            reader.readAsText(file);
        }
        
        function getFiberTypeOptions(selectedValue) {
            const types = ['06 FO', '12 FO', '24 FO', '36 FO', '72 FO'];
            return types.map(type => `<option value="Fibra Óptica ${type}" ${`Fibra Óptica ${type}` === selectedValue ? 'selected' : ''}>${type}</option>`).join('');
        }

        function renderFiberRuns() {
            const container = document.getElementById('fiber-runs-container');
            container.innerHTML = fiberRuns.map((run, index) => `
                <div class="flex items-center justify-center gap-4 p-2 border rounded-lg">
                    <div class="flex flex-col items-center">
                        <label class="font-semibold text-gray-600">Tipo de Fibra</label>
                        <select onchange="handleFiberRunChange(${index}, 'type', this.value)" class="mt-1 w-full text-center p-1 rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500">
                            ${getFiberTypeOptions(run.type)}
                        </select>
                    </div>
                    <div class="flex-1 flex flex-col items-center">
                        <label class="font-semibold text-gray-600">Metragem (m)</label>
                        <input oninput="handleFiberRunChange(${index}, 'length', this.value)" type="number" value="${run.length || ''}" placeholder="Ex: 5000" class="mt-1 w-full text-center p-1 rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500">
                    </div>
                    <button onclick="removeFiberRun(${index})" title="Remover Lançamento" class="p-2 bg-red-100 text-red-600 rounded-md hover:bg-red-200 transition-colors self-end">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            `).join('');
        }

        function addFiberRun() {
            fiberRuns.push({ type: 'Fibra Óptica 12 FO', length: 0 });
            renderFiberRuns();
            updateMaterialsList();
        }

        function removeFiberRun(index) {
            if (fiberRuns.length > 1) {
                fiberRuns.splice(index, 1);
                renderFiberRuns();
                updateMaterialsList();
            } else {
                showModal("Ação Inválida", "Não é possível remover o último lançamento de fibra.", false);
            }
        }

        function handleFiberRunChange(index, field, value) {
            fiberRuns[index][field] = (field === 'length') ? (parseFloat(value) || 0) : value;
            updateMaterialsList();
        }

        function saveManualMaterial(event, id, value) {
            const focusedElementId = event.target.id;
            const selectionStart = event.target.selectionStart;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                manualMaterials[id] = parseInt(value, 10) || 0;
                updateMaterialsList();
                
                const focusedElement = document.getElementById(focusedElementId);
                if (focusedElement) {
                    focusedElement.focus({ preventScroll: true });
                    focusedElement.setSelectionRange(selectionStart, selectionStart);
                }
            }, 500);
        }
        
        function saveMaterialPrice(event, id, value) {
            const focusedElementId = event.target.id;
            const selectionStart = event.target.selectionStart;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const price = parseFloat(value.replace(',', '.')) || 0;
                materialPrices[id] = price;
                updateMaterialsList();
                
                const focusedElement = document.getElementById(focusedElementId);
                if (focusedElement) {
                    focusedElement.focus({ preventScroll: true });
                    focusedElement.setSelectionRange(selectionStart, selectionStart);
                }
            }, 500);
        }

        function addCto() {
            const lastSegment = networkSegments[networkSegments.length - 1];
            networkSegments.push({
                splitterHub: 'Ausente',
                splitterCto: 'Ausente', // Alterado para não herdar o splitter
                distance: 0,
                spliceCount: 0,
                geo: null,
                description: '',
                colorGroup: (lastSegment.colorGroup + 1) % 12
            });
            recalculateUnbalanced();
        }

        function removeCto(index) {
            if (networkSegments.length >= 1) {
                networkSegments.splice(index, 1);
                recalculateUnbalanced();
            }
        }

        function addBalancedCto() {
            const lastCto = balancedNetworkCtos[balancedNetworkCtos.length - 1];
            const newColorGroup = lastCto ? (lastCto.colorGroup + 1) % 12 : 0;
            balancedNetworkCtos.push({ distance: 0, spliceCount: 0, geo: null, description: '', colorGroup: newColorGroup });
            recalculateBalanced();
        }

        function removeBalancedCto(index) {
            if (balancedNetworkCtos.length >= 1) {
                balancedNetworkCtos.splice(index, 1);
                recalculateBalanced();
            }
        }

        window.onload = function() {
            updateUIWithLoadedData();
        };
    
    </script>

</body>
</html>

