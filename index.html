<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de CTOs</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f4f9;
            color: #333;
            padding: 1rem;
        }
        .container {
            max-width: 1280px;
            margin: auto;
            background-color: #fff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .section-card {
            background-color: #fff;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .input-field {
            @apply w-24 text-xs p-1 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out flex-shrink-0;
            text-align: center;
        }
        .result-field {
            @apply w-24 text-center text-xs p-1 border border-gray-200 rounded-md bg-gray-100 font-semibold text-gray-700 flex-shrink-0;
        }
        .signal-good { @apply bg-green-100 border-green-300 text-green-800; }
        .signal-warn { @apply bg-yellow-100 border-yellow-300 text-yellow-800; }
        .signal-bad { @apply bg-red-100 border-red-300 text-red-800; }
        .tab-button {
            @apply whitespace-nowrap py-3 px-4 font-medium text-lg transition-colors duration-200 border-b-2;
        }
        .tab-button:not(.tab-active) {
            @apply text-gray-500 border-gray-200 hover:text-gray-700 hover:border-gray-300;
        }
        .tab-active {
            @apply text-white rounded-t-lg shadow-md border-transparent;
        }
        #tab-desbalanceada.tab-active {
            background: linear-gradient(to right, #F97316, #EF4444); /* orange-500 to red-600 */
        }
        #tab-balanceada.tab-active {
            background: linear-gradient(to right, #2563EB, #7C3AED); /* blue-600 to violet-600 */
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        .loss-detail {
            @apply w-24 text-xs text-center text-red-600 font-medium p-1 flex-shrink-0;
        }
        .geo-button {
            @apply mt-2 px-2 py-1 text-xs font-bold rounded-lg shadow-sm transition-colors duration-150;
        }
        .manual-signal-field {
          @apply mt-2 w-full text-center text-xs text-gray-500 italic;
        }
        .printable-only-description {
            display: none;
        }
       
       @media print {
            body > .container > header,
            body .border-b.no-print,
            body .tab-panel:not(.active-for-print) {
                display: none;
            }

            body .no-print {
                display: none !important;
            }
            
            body .tab-panel.active-for-print {
                display: block !important;
            }

            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size: 9pt; }
            .printable-area { box-shadow: none !important; border: none !important; }
            h2 { font-size: 1.25rem; }
            #network-layout-container, #balanced-network-container { gap: 0.5rem; }
            .cto-card-print { width: 240px !important; page-break-inside: avoid; }
            .printable-only-description { display: block; margin-top: 0.5rem; text-align: left; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header class="text-center mb-8 no-print flex justify-between items-start">
            <div>
                <h1 id="main-title" class="text-3xl md:text-4xl font-extrabold text-gray-800 text-left">Gerenciador de CTOs</h1>
                <p class="text-lg text-gray-500 mt-2 text-left">Planeje e calcule a potência para redes ópticas balanceadas e desbalanceadas.</p>
            </div>
            <div class="relative">
                <button id="project-menu-button" class="bg-white text-gray-700 font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-100 transition flex items-center border border-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1zM3 16a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" />
                    </svg>
                    <span>Projeto</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
                <div id="project-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20 border">
                    <input type="file" id="file-input" class="hidden" accept=".json" onchange="loadProject(event)">
                    <label for="file-input" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">Abrir Projeto</label>
                    <a href="#" onclick="saveProject()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Salvar Projeto</a>
                </div>
            </div>
        </header>

        <div class="border-b border-gray-200 mt-8 no-print">
            <nav class="-mb-px flex justify-center space-x-4" aria-label="Tabs">
                <button id="tab-desbalanceada" onclick="switchTab('desbalanceada')" class="tab-button tab-active">Rede Desbalanceada</button>
                <button id="tab-balanceada" onclick="switchTab('balanceada')" class="tab-button">Rede Balanceada</button>
            </nav>
        </div>

        <!-- Painel Rede Desbalanceada -->
        <div id="tab-panel-desbalanceada" class="tab-panel printable-area">
            <div class="section-card">
                <h2 class="text-2xl font-bold text-center text-gray-700 mb-4">Parâmetros da Rede Desbalanceada</h2>
                 <div class="max-w-md mx-auto mb-6">
                     <label for="map-link-input-unbalanced" class="font-bold text-lg text-gray-600 text-center block mb-2">Link do Mapa (Google My Maps)</label>
                     <div class="flex items-center">
                         <input id="map-link-input-unbalanced" oninput="handleMapLinkChange(this)" type="url" placeholder="Cole o link compartilhável do seu mapa aqui" class="w-full p-2 rounded-l-md font-bold border-2 border-gray-300 focus:border-indigo-500">
                         <button onclick="viewProjectMap()" title="Visualizar Mapa" class="bg-blue-600 text-white p-3 rounded-r-md hover:bg-blue-700 transition no-print">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.527-1.912 6.01 6.01 0 012.142 4.072 6.01 6.01 0 01-3.668 5.473 1.503 1.503 0 01-1.499.044 2 2 0 00-2.427 0 2 2 0 01-1.527 1.912 6.01 6.01 0 01-3.8-5.57z" clip-rule="evenodd" /></svg>
                         </button>
                     </div>
                </div>
                 <div class="max-w-xs mx-auto mb-6">
                    <label for="olt-power-input-unbalanced" class="font-bold text-lg text-gray-600 text-center block mb-2">Potência OLT</label>
                    <div class="flex items-center">
                        <input type="text" id="olt-power-input-unbalanced" oninput="handleOltPowerChange(this)" value="7.00" class="w-full p-2 text-center rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500"/>
                        <span class="font-semibold text-gray-700 ml-2">dBm</span>
                    </div>
                </div>
                <div id="network-layout-container" class="flex flex-wrap justify-center gap-4">
                    <!-- CTO cards for unbalanced network will be inserted here -->
                </div>
                <div class="flex flex-wrap justify-center mt-6 gap-4">
                    <button onclick="printCtoReport()" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white font-bold py-3 px-5 rounded-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-300 ease-in-out flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7V9h6v3z" clip-rule="evenodd" /></svg>
                        Imprimir CTOs
                    </button>
                     <button onclick="downloadFieldReport()" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white font-bold py-3 px-5 rounded-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-300 ease-in-out flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        Relatório de Campo
                    </button>
                    <button onclick="shareProject()" class="bg-gradient-to-r from-green-500 to-green-600 text-white font-bold py-3 px-5 rounded-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-300 ease-in-out flex items-center justify-center">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367 2.684z" /></svg>
                        Compartilhar
                    </button>
                    <button onclick="addCto()" class="bg-gradient-to-r from-orange-500 to-red-600 text-white font-bold py-3 px-5 rounded-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-300 ease-in-out flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        Adicionar CTO
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Painel Rede Balanceada -->
        <div id="tab-panel-balanceada" class="hidden tab-panel printable-area">
             <div class="section-card">
                <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Parâmetros da Rede Balanceada</h2>
                <div class="max-w-md mx-auto mb-6">
                     <label for="map-link-input-balanced" class="font-bold text-lg text-gray-600 text-center block mb-2">Link do Mapa (Google My Maps)</label>
                     <div class="flex items-center">
                         <input id="map-link-input-balanced" oninput="handleMapLinkChange(this)" type="url" placeholder="Cole o link compartilhável do seu mapa aqui" class="w-full p-2 rounded-l-md font-bold border-2 border-gray-300 focus:border-indigo-500">
                         <button onclick="viewProjectMap()" title="Visualizar Mapa" class="bg-blue-600 text-white p-3 rounded-r-md hover:bg-blue-700 transition no-print">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.527-1.912 6.01 6.01 0 012.142 4.072 6.01 6.01 0 01-3.668 5.473 1.503 1.503 0 01-1.499.044 2 2 0 00-2.427 0 2 2 0 01-1.527 1.912 6.01 6.01 0 01-3.8-5.57z" clip-rule="evenodd" /></svg>
                         </button>
                     </div>
                </div>
                 <div class="max-w-xs mx-auto mb-6">
                    <label for="olt-power-input-balanced" class="font-bold text-lg text-gray-600 text-center block mb-2">Potência OLT</label>
                    <div class="flex items-center">
                        <input type="text" id="olt-power-input-balanced" oninput="handleOltPowerChange(this)" value="7.00" class="w-full p-2 text-center rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500"/>
                        <span class="font-semibold text-gray-700 ml-2">dBm</span>
                    </div>
                </div>
                <div class="max-w-4xl mx-auto grid grid-cols-1 gap-6 bg-gray-50 p-4 rounded-lg border mb-6">
                    <div class="flex flex-col items-center">
                        <label for="balanced-primary-splitter" class="font-bold text-lg text-gray-600">Splitter Primário (CEOA)</label>
                        <select id="balanced-primary-splitter" onchange="handleBalancedConfigChange('primarySplitter', this.value)" class="mt-1 w-full max-w-xs text-center p-2 rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500"></select>
                    </div>
                </div>
                 <div id="balanced-network-container" class="flex flex-wrap justify-center gap-4">
                     <!-- CTO cards for balanced network will be inserted here -->
                 </div>
                 <div class="flex flex-wrap justify-center mt-6 gap-4">
                    <button onclick="printCtoReport()" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white font-bold py-3 px-5 rounded-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-300 ease-in-out flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7V9h6v3z" clip-rule="evenodd" /></svg>
                         Imprimir CTOs
                     </button>
                    <button onclick="downloadFieldReport()" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white font-bold py-3 px-5 rounded-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-300 ease-in-out flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        Relatório de Campo
                    </button>
                     <button onclick="shareProject()" class="bg-gradient-to-r from-green-500 to-green-600 text-white font-bold py-3 px-5 rounded-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-300 ease-in-out flex items-center justify-center">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367 2.684z" /></svg>
                        Compartilhar
                    </button>
                     <button onclick="addBalancedCto()" class="bg-gradient-to-r from-orange-500 to-red-600 text-white font-bold py-3 px-5 rounded-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-300 ease-in-out flex items-center justify-center">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                         Adicionar CTO
                     </button>
                 </div>
             </div>
        </div>
    </div>
    
    <!-- Modal para Descrição -->
    <div id="description-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6 text-left">
                <h3 class="text-xl font-bold text-gray-800">Descrição do Sinal</h3>
                <div class="mt-4">
                    <label for="signal-description-input" class="block text-sm font-medium text-gray-700">Adicione uma nota sobre o sinal medido:</label>
                    <textarea id="signal-description-input" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
            </div>
            <div class="bg-gray-100 px-6 py-4 flex justify-end gap-3 rounded-b-lg">
                <button onclick="closeDescriptionModal()" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Cancelar</button>
                <button onclick="saveDescription()" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Alertas -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-800 text-left" id="modal-title"></h3>
                <div class="mt-4">
                    <p class="text-md text-gray-600 text-left whitespace-pre-line" id="modal-content"></p>
                </div>
            </div>
            <div class="bg-gray-100 px-6 py-4 flex justify-end gap-3 rounded-b-lg">
                <button id="ok-btn" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">OK</button>
            </div>
        </div>
    </div>


    <script>
        // --- Variáveis de Estado Globais ---
        let oltPower = 7.00;
        let projectName = '';
        let googleMapsUrl = '';
        let activeTab = 'desbalanceada';
        let networkSegments = [];
        let balancedConfig = { primarySplitter: '1:8' };
        let balancedNetworkCtos = [];
        const FIBER_LOSS_PER_KM = 0.10;
        const FUSION_SPLICE_LOSS = 0.10;
        let debounceTimer = null;
        let currentCtoInfo = null;

        const FIBER_COLORS = [
            { name: 'Verde', hex: '#28a745', text: 'white' }, { name: 'Amarelo', hex: '#ffc107', text: 'black' },
            { name: 'Branco', hex: '#ffffff', text: 'black' }, { name: 'Azul', hex: '#007bff', text: 'white' },
            { name: 'Vermelho', hex: '#dc3545', text: 'white' }, { name: 'Violeta', hex: '#6f42c1', text: 'white' },
            { name: 'Marrom', hex: '#a52a2a', text: 'white' }, { name: 'Rosa', hex: '#e83e8c', text: 'white' },
            { name: 'Preto', hex: '#000000', text: 'white' }, { name: 'Cinza', hex: '#6c757d', text: 'white' },
            { name: 'Laranja', hex: '#fd7e14', text: 'white' }, { name: 'Aqua', hex: '#00ffff', text: 'black' }
        ];
    
        const UNBALANCED_PARAMETER_ROWS = [
          { label: 'Sinal Entrada', key: 'sinalEntradaHub', type: 'result' },
          { label: 'Splitter Desb.', key: 'splitterHub', type: 'select_hub' },
          { label: 'Perda Passagem', key: 'perdaPassagemHub', type: 'result_detail' },
          { label: 'Sinal Saída', key: 'sinalSaidaHub', type: 'result' },
          { label: 'Perda Trecho', key: 'perdaTotalTrecho', type: 'result_detail' },
          { label: 'Splitter CTO', key: 'splitterCto', type: 'select_cto' },
          { label: 'Sinal Final CTO', key: 'sinalFinalCto', type: 'result_final' },
        ];
        
        const splitterLosses = { 
          'Ausente': { drop: 0, pass: 0 }, '1:2': { drop: 3.7 }, '1:4': { drop: 7.1 }, '1:8': { drop: 10.5 }, '1:16': { drop: 13.7 }, '1:32': { drop: 17.1 }, '1:64': { drop: 20.4 }, '1:128': { drop: 23.9 }, '1:99': { drop: 21.6, pass: 0.3 }, '2:98': { drop: 18.7, pass: 0.4 }, '4:96': { drop: 14.9, pass: 0.4 }, '5:95': { drop: 14.6, pass: 0.5 }, '7:93': { drop: 13.0, pass: 0.6 }, '10:90': { drop: 11.0, pass: 0.7 }, '15:85': { drop: 9.6,  pass: 1.0 }, '20:80': { drop: 7.9,  pass: 1.4 }, '25:75': { drop: 6.95, pass: 1.7 }, '30:70': { drop: 6.0,  pass: 1.9 }, '35:65': { drop: 5.35, pass: 2.3 }, '40:60': { drop: 4.7,  pass: 2.7 }, '45:55': { drop: 4.15, pass: 3.15 }, '50:50': { drop: 3.7,  pass: 2.5 },
        };
        
        function getSignalColorClass(signal) { if (isNaN(signal) || signal === null) return 'bg-gray-100 border-gray-300 text-gray-500'; if (signal < -22) return 'signal-bad'; if (signal < -19) return 'signal-warn'; return 'signal-good'; }
        
        function getSplitterOptions(type, selectedValue) { 
            let list;
            if (type === 'hub') {
                list = Object.keys(splitterLosses).filter(k => splitterLosses[k].pass !== undefined);
            } else if (type === 'balanced') {
                list = Object.keys(splitterLosses).filter(k => splitterLosses[k].pass === undefined && k !== 'Ausente');
            } else { // cto
                list = Object.keys(splitterLosses).filter(k => splitterLosses[k].pass === undefined || k === 'Ausente');
            }
            return list.map(key => `<option value="${key}" ${key === selectedValue ? 'selected' : ''}>${key}</option>`).join('');
        }

        function switchTab(tabName) {
            activeTab = tabName;
            const tabs = ['desbalanceada', 'balanceada'];
            tabs.forEach(tab => {
                document.getElementById(`tab-panel-${tab}`).classList.add('hidden');
                document.getElementById(`tab-${tab}`).classList.remove('tab-active');
            });
            document.getElementById(`tab-panel-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');
        }

        function showModal(title, content) {
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            
            if(modal) {
                modalTitle.innerText = title;
                modalContent.innerText = content;
                modal.classList.remove('hidden');

                const okBtn = document.getElementById('ok-btn');
                okBtn.onclick = () => modal.classList.add('hidden');
            }
        }

        function showDescriptionModal(index, networkType) {
            currentCtoInfo = { index, networkType };
            const modal = document.getElementById('description-modal');
            const descriptionInput = document.getElementById('signal-description-input');
            const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
            descriptionInput.value = network[index].description || '';
            modal.classList.remove('hidden');
        }

        function saveDescription() {
            if (currentCtoInfo !== null) {
                const { index, networkType } = currentCtoInfo;
                const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
                network[index].description = document.getElementById('signal-description-input').value;
                if (networkType === 'unbalanced') renderUnbalancedNetwork();
                else renderBalancedNetwork();
            }
            closeDescriptionModal();
        }
        
        function closeDescriptionModal() {
            document.getElementById('description-modal').classList.add('hidden');
        }

        function renderUnbalancedNetwork() {
            const container = document.getElementById('network-layout-container');
            container.innerHTML = ''; 
            networkSegments.forEach((segment, index) => {
                const ctoCard = createCtoCard(segment, index, 'unbalanced');
                container.appendChild(ctoCard);
            });
        }
        
        function renderBalancedNetwork() {
            const container = document.getElementById('balanced-network-container');
            container.innerHTML = '';
            document.getElementById('balanced-primary-splitter').innerHTML = getSplitterOptions('balanced', balancedConfig.primarySplitter);
            balancedNetworkCtos.forEach((cto, index) => {
                const ctoCard = createCtoCard(cto, index, 'balanced');
                container.appendChild(ctoCard);
            });
        }

        function createCtoCard(data, index, networkType) {
            const isUnbalanced = networkType === 'unbalanced';
            const geoText = data.geo ? `${data.geo.lat.toFixed(5)}, ${data.geo.lon.toFixed(5)}` : 'N/A';
            const cardIdPrefix = isUnbalanced ? 'U' : 'B';
            const title = isUnbalanced ? `CTO-${String(index + 1).padStart(2, '0')}` : `CTO Bal.-${String(index + 1).padStart(2, '0')}`;
            const selectedColor = FIBER_COLORS[data.colorGroup || 0];
            
            const ctoCard = document.createElement('div');
            ctoCard.className = "cto-card-print flex flex-col items-center bg-gray-50 rounded-lg shadow-md border p-3";
            ctoCard.style.width = "280px";
            
            let cardHtml = `
            <h3 class="relative text-lg font-bold mb-3 px-4 py-1 rounded-full border border-gray-300" 
                 style="background-color:${selectedColor.hex}; color:${selectedColor.text};">
                ${title}
                <button onclick="${isUnbalanced ? 'removeCto' : 'removeBalancedCto'}(${index})" title="Remover CTO" class="absolute -top-2 -right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors no-print"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </h3>
            <div class="flex flex-col items-center mb-2 w-full">
                <span class="text-xs font-semibold text-gray-600">Geolocalização:</span>
                <span class="text-xs text-gray-500 mt-1 printable-geo">${geoText}</span>
                <div class="flex gap-1 mt-1">
                    <button onclick="getGeoLocation(${index}, '${networkType}')" class="geo-button bg-blue-500 text-white hover:bg-blue-600 no-print flex-1 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg> GPS</button>
                    <button onclick="copyGeoLocation(${index}, '${networkType}')" class="geo-button bg-gray-500 text-white hover:bg-gray-600 no-print flex-1 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg> Copiar</button>
                    <button onclick="openInGoogleMaps(${index}, '${networkType}')" class="geo-button bg-green-500 text-white hover:bg-green-600 no-print flex-1 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg> Mapa</button>
                </div>
                <div class="flex items-center mt-2 w-full">
                    <input id="manual-geo-input-${cardIdPrefix}-${index}" type="text" placeholder="Inserir Coords." class="w-full text-center text-xs p-1 rounded-l-md border-2 border-gray-300 focus:border-indigo-500">
                    <button onclick="saveManualGeo(${index}, '${networkType}')" class="bg-indigo-500 text-white text-xs font-bold p-1.5 rounded-r-md hover:bg-indigo-600 transition">Salvar</button>
                </div>
            </div>
            <div class="flex items-center w-full mb-1.5 px-2">
                <label class="flex-1 text-xs font-semibold text-gray-600">Distancia (m):</label>
                <input id="cto-${cardIdPrefix}-${index}-distance" type="number" value="${data.distance || 0}" oninput="handleCtoDataChange(event, ${index}, '${networkType}', 'distance')" class="input-field" />
            </div>
            <div class="flex items-center w-full mb-1.5 px-2">
                <label class="flex-1 text-xs font-semibold text-gray-600">Nº de Fusões:</label>
                <input id="cto-${cardIdPrefix}-${index}-spliceCount" type="number" value="${data.spliceCount || 0}" oninput="handleCtoDataChange(event, ${index}, '${networkType}', 'spliceCount')" class="input-field" />
            </div>
            <div class="flex items-center w-full mb-1.5 px-2">
                <label class="flex-1 text-xs font-semibold text-gray-600">Cor da Fibra:</label>
                <select id="cto-${cardIdPrefix}-${index}-colorGroup" oninput="handleCtoDataChange(event, ${index}, '${networkType}', 'colorGroup')" class="input-field font-semibold" style="background-color:${selectedColor.hex}; color:${selectedColor.text}; border-color: #999;">
                    ${FIBER_COLORS.map((color, colorIndex) => `<option value="${colorIndex}" ${colorIndex === (data.colorGroup || 0) ? 'selected' : ''} style="background-color:${color.hex}; color:${color.text};">${colorIndex + 1} - ${color.name}</option>`).join('')}
                </select>
            </div>
            <div class="w-full">`;
            
            const parameterRows = isUnbalanced ? UNBALANCED_PARAMETER_ROWS : [
                { label: 'Splitter CTO', key: 'splitterCto', type: 'select_cto' },
                { label: 'Sinal Final CTO', key: 'sinalFinal', type: 'result_final' }
            ];
            
            parameterRows.forEach(row => {
                const value = data[row.key];
                if (row.type === 'result_final') {
                    const finalSignal = parseFloat(value);
                    const colorClass = getSignalColorClass(finalSignal);
                    cardHtml += `<div class="flex justify-between items-center w-full mb-1.5 px-2"><label class="text-xs font-semibold text-gray-600">${row.label}:</label><div class="px-3 py-1 text-sm font-bold rounded-full ${colorClass}">${value || '---'} dBm</div></div>`;
                } else {
                    cardHtml += `<div class="flex items-center w-full mb-1.5 px-2"><label class="flex-1 text-xs font-semibold text-gray-600">${row.label}:</label>`;
                    switch(row.type) {
                        case 'select_hub': cardHtml += `<select oninput="handleCtoDataChange(event, ${index}, '${networkType}', 'splitterHub')" class="input-field">${getSplitterOptions('hub', data.splitterHub)}</select>`; break;
                        case 'select_cto':
                             const optionsType = isUnbalanced ? 'cto' : 'balanced';
                             cardHtml += `<select oninput="handleCtoDataChange(event, ${index}, '${networkType}', 'splitterCto')" class="input-field">${getSplitterOptions(optionsType, data.splitterCto)}</select>`;
                             break;
                        case 'result': cardHtml += `<input type="text" value="${value || '---'}" readonly class="result-field" />`; break;
                        case 'result_detail': cardHtml += `<div class="loss-detail">${value || '---'}</div>`; break;
                    }
                    cardHtml += `</div>`;
                }
            });
            
            cardHtml += `<div class="mt-2 w-full text-center text-xs text-gray-500 font-bold no-print flex items-center justify-between"><span>Sinal Medido em Campo</span><button onclick="showDescriptionModal(${index}, '${networkType}')" class="p-1 rounded-full text-white bg-gray-500 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400" title="Adicionar/Editar Descrição"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button></div><div class="manual-signal-field no-print"><span class="text-xs text-gray-500 italic">${data.description || 'Nenhuma descrição salva.'}</span></div><div class="printable-only-description"><span class="text-xs font-bold text-gray-700">Descrição: </span><span>${data.description || 'N/A'}</span></div></div>`;
            ctoCard.innerHTML = cardHtml;
            return ctoCard;
        }
    
        function recalculateUnbalanced() {
            let powerForNextSegment = oltPower;
            let isPathBroken = false;
            networkSegments.forEach((segment) => {
                if (isPathBroken) {
                     Object.assign(segment, { sinalEntradaHub: null, perdaPassagemHub: null, sinalSaidaHub: null, perdaTotalTrecho: null, sinalFinalCto: null });
                     return;
                }
                const distanceInKm = (segment.distance || 0) / 1000;
                const fusionLoss = (segment.spliceCount || 0) * FUSION_SPLICE_LOSS;
                const totalSegmentLoss = (distanceInKm * FIBER_LOSS_PER_KM) + fusionLoss;
                segment.perdaTotalTrecho = totalSegmentLoss.toFixed(2) + ' dB';

                const sinalEntradaHub = powerForNextSegment - totalSegmentLoss;
                segment.sinalEntradaHub = sinalEntradaHub.toFixed(2);
                
                const hubSplitter = splitterLosses[segment.splitterHub] || { drop: 0, pass: 0 };
                const ctoSplitter = splitterLosses[segment.splitterCto] || { drop: 0 };
                
                segment.perdaPassagemHub = (hubSplitter.pass || 0).toFixed(2) + ' dB';
                
                const sinalFinalCto = sinalEntradaHub - hubSplitter.drop - ctoSplitter.drop;
                segment.sinalFinalCto = (segment.splitterCto === 'Ausente') ? null : sinalFinalCto.toFixed(2);
                
                const sinalSaidaHub = sinalEntradaHub - hubSplitter.pass;
                segment.sinalSaidaHub = sinalSaidaHub.toFixed(2);
                
                powerForNextSegment = sinalSaidaHub;
                
                if (segment.splitterHub === 'Ausente' || isNaN(sinalSaidaHub)) {
                    isPathBroken = true;
                    segment.sinalSaidaHub = null;
                    segment.perdaPassagemHub = null;
                }
            });
            renderUnbalancedNetwork();
        }

        function recalculateBalanced() {
            const primaryLoss = splitterLosses[balancedConfig.primarySplitter]?.drop || 0;
            const powerAfterPrimary = oltPower - primaryLoss;

            balancedNetworkCtos.forEach(cto => {
                const secondaryLoss = splitterLosses[cto.splitterCto]?.drop || 0;
                const distanceLoss = ((cto.distance || 0) / 1000) * FIBER_LOSS_PER_KM;
                const spliceLoss = (cto.spliceCount || 0) * FUSION_SPLICE_LOSS;
                const totalLoss = distanceLoss + spliceLoss + secondaryLoss;
                const finalSignal = powerAfterPrimary - totalLoss;
                cto.sinalFinal = finalSignal.toFixed(2);
            });
            renderBalancedNetwork();
        }
    
        function updateUIWithLoadedData() {
            document.getElementById('main-title').innerText = projectName ? `Projeto: ${projectName}` : 'Gerenciador de CTOs';
            document.title = projectName || 'Gerenciador de CTOs';

            document.getElementById('olt-power-input-unbalanced').value = oltPower.toFixed(2);
            document.getElementById('olt-power-input-balanced').value = oltPower.toFixed(2);

            document.getElementById('map-link-input-unbalanced').value = googleMapsUrl;
            document.getElementById('map-link-input-balanced').value = googleMapsUrl;
            
            recalculateUnbalanced();
            recalculateBalanced();
        }
    
        function handleOltPowerChange(inputElement) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const newValue = parseFloat(inputElement.value.replace(',', '.'));
                if (!isNaN(newValue)) {
                    oltPower = newValue;
                    
                    const unbalancedInput = document.getElementById('olt-power-input-unbalanced');
                    const balancedInput = document.getElementById('olt-power-input-balanced');
                    
                    if (inputElement.id === 'olt-power-input-unbalanced') {
                        balancedInput.value = inputElement.value;
                    } else {
                        unbalancedInput.value = inputElement.value;
                    }

                    recalculateUnbalanced();
                    recalculateBalanced();
                }
            }, 500);
        }
    
        function handleCtoDataChange(event, index, networkType, field) {
             const focusedElementId = event.target.id;
             const selectionStart = event.target.selectionStart;
             clearTimeout(debounceTimer);
             debounceTimer = setTimeout(() => {
                const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
                let value = event.target.value;

                if (field === 'distance' || field === 'spliceCount' || field === 'colorGroup') {
                    value = parseFloat(value) || 0;
                }
                 
                if (network[index]) { 
                    network[index][field] = value; 
                }
                
                if (networkType === 'unbalanced' && field === 'splitterCto') {
                    networkSegments[index][field] = value;
                }

                if (networkType === 'unbalanced') recalculateUnbalanced();
                else recalculateBalanced();
                
                const focusedElement = document.getElementById(focusedElementId);
                if (focusedElement) {
                    focusedElement.focus({ preventScroll: true });
                    if (focusedElement.setSelectionRange) {
                        focusedElement.setSelectionRange(selectionStart, selectionStart);
                    }
                }

             }, 500);
        }

        function handleBalancedConfigChange(field, value) {
            balancedConfig[field] = value;
            recalculateBalanced();
        }

        function handleMapLinkChange(inputElement) {
            const url = inputElement.value.trim();
            googleMapsUrl = url;

            const unbalancedInput = document.getElementById('map-link-input-unbalanced');
            const balancedInput = document.getElementById('map-link-input-balanced');
            
            if (inputElement.id === 'map-link-input-unbalanced') {
                balancedInput.value = url;
            } else if (inputElement.id === 'map-link-input-balanced') {
                unbalancedInput.value = url;
            }
        }

        function viewProjectMap() {
            if (googleMapsUrl && googleMapsUrl.trim() !== '') {
                try {
                    new URL(googleMapsUrl);
                    window.open(googleMapsUrl, '_blank');
                } catch (e) {
                    showModal("URL Inválida", "Por favor, insira um link válido começando com http:// ou https://");
                }
            } else {
                showModal("Nenhum Mapa Definido", "Por favor, insira um link do Google My Maps no campo correspondente.");
            }
        }

        function copyGeoLocation(index, networkType) {
            const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
            const segment = network[index];
            if (segment && segment.geo) {
                const geoString = `${segment.geo.lat}, ${segment.geo.lon}`;
                const textArea = document.createElement("textarea");
                textArea.value = geoString;
                textArea.style.position = "fixed"; 
                textArea.style.top = "-9999px";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showModal("Coordenadas Copiadas", `O texto "${geoString}" foi copiado para a área de transferência.`);
                } catch (err) {
                    showModal("Erro ao Copiar", "Não foi possível copiar as coordenadas.");
                }
                document.body.removeChild(textArea);
            } else {
                showModal("Geolocalização Ausente", "Primeiro, clique em 'GPS' para capturar as coordenadas.");
            }
        }

       function openInGoogleMaps(index, networkType) {
            const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
            const cto = network[index];
            
            if (!cto.geo) {
                showModal("Geolocalização Ausente", "Por favor, capture as coordenadas GPS ou insira-as manualmente primeiro.");
                return;
            }
            
            if (googleMapsUrl && googleMapsUrl.trim() !== '') {
                 const geoString = `${cto.geo.lat.toFixed(5)}, ${cto.geo.lon.toFixed(5)}`;
                 navigator.clipboard.writeText(geoString).then(() => {
                     window.open(googleMapsUrl, '_blank');
                     showModal("Coordenadas Copiadas", `As coordenadas "${geoString}" foram copiadas. Agora, cole-as no seu mapa para adicionar o ponto.`);
                 }, () => {
                     showModal("Erro ao Copiar", "Não foi possível copiar as coordenadas para a área de transferência.");
                 });
            } else {
                 const lat = cto.geo.lat;
                 const lon = cto.geo.lon;
                 const url = `https://www.google.com/maps?q=${lat},${lon}`;
                 window.open(url, '_blank');
            }
        }
    
        function getGeoLocation(index, networkType) {
            if (!navigator.geolocation) {
                showModal("Geolocalização Não Suportada", "O seu navegador não suporta a API de Geolocalização.");
                return;
            }
            
            if (window.isSecureContext === false) {
                 showModal("Conexão Insegura", "O GPS não pode ser ativado em conexões não seguras (HTTP ou local). Por favor, hospede o ficheiro num servidor com HTTPS para usar esta funcionalidade.");
                 return;
            }

            showModal("A obter localização...", "Por favor, aguarde enquanto o GPS está a ser capturado.\n\nPode ser necessário autorizar o acesso à sua localização no navegador.");
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    network[index].geo = { lat: lat, lon: lon };
                    showModal("Localização Capturada!", `As coordenadas ${lat.toFixed(5)}, ${lon.toFixed(5)} foram guardadas.`);
                    if (networkType === 'unbalanced') renderUnbalancedNetwork();
                    else renderBalancedNetwork();
                },
                (error) => {
                    let message = "Ocorreu um erro desconhecido.";
                    if (error.code === 1) { // PERMISSION_DENIED
                         message = "A permissão de acesso ao GPS foi negada.\n\nVerifique as permissões do seu navegador para este site. Lembre-se que o GPS só funciona em conexões seguras (HTTPS).";
                    } else if (error.code === 2) { // POSITION_UNAVAILABLE
                         message = "Localização indisponível. Não foi possível obter a sua posição atual.";
                    } else if (error.code === 3) { // TIMEOUT
                         message = "Tempo esgotado ao tentar obter a localização.";
                    }
                    showModal("Erro de Geolocalização", message);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
        
        function saveManualGeo(index, networkType) {
            const cardIdPrefix = networkType === 'unbalanced' ? 'U' : 'B';
            const input = document.getElementById(`manual-geo-input-${cardIdPrefix}-${index}`);
            const coordsString = input.value.trim();
            if (coordsString) {
                const parts = coordsString.replace(/ /g, '').split(',');
                if (parts.length === 2) {
                    const lat = parseFloat(parts[0]);
                    const lon = parseFloat(parts[1]);
                    if (!isNaN(lat) && !isNaN(lon)) {
                        const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
                        network[index].geo = { lat, lon };
                        if (networkType === 'unbalanced') renderUnbalancedNetwork();
                        else renderBalancedNetwork();
                        showModal("Coordenadas Guardadas", `As coordenadas ${lat}, ${lon} foram guardadas com sucesso.`);
                        input.value = '';
                        return;
                    }
                }
            }
            showModal("Formato Inválido", "Por favor, insira as coordenadas no formato 'latitude, longitude'. Ex: -12.345, -39.876");
        }

        async function shareProject() {
            let message = `*Relatório de CTOs*\n\n`;
            message += `*Potência OLT:* ${oltPower.toFixed(2)} dBm\n`;
            if (googleMapsUrl) {
                message += `*Link do Mapa:* ${googleMapsUrl}\n`;
            }
            message += `\n`;
            
            message += `--- *SIMULAÇÃO REDE BALANCEADA* ---\n`;
            message += `Splitter Primário: ${balancedConfig.primarySplitter}\n\n`;
            balancedNetworkCtos.forEach((cto, index) => {
                message += `*CTO Bal.-${String(index + 1).padStart(2, '0')}*\n`;
                message += `Dist.: ${cto.distance || 0}m, Fusões: ${cto.spliceCount || 0}\n`;
                message += `Splitter CTO: ${cto.splitterCto}\n`;
                message += `*Sinal Final Estimado:* ${cto.sinalFinal} dBm\n`;
                if (cto.geo) {
                    message += `Geolocalização: ${cto.geo.lat}, ${cto.geo.lon}\n`;
                }
                message += `\n`;
            });

            message += `--- *SIMULAÇÃO REDE DESBALANCEADA* ---\n\n`;
            networkSegments.forEach((segment, index) => {
                if (segment.splitterHub !== 'Ausente') {
                    const colorInfo = FIBER_COLORS[segment.colorGroup || 0];
                    message += `*CTO-${String(index + 1).padStart(2, '0')} (${colorInfo.name})*\n`;
                    message += `Dist.: ${segment.distance || 0}m, Fusões: ${segment.spliceCount || 0}\n`;
                    message += `Sinal Entrada: ${segment.sinalEntradaHub} dBm\n`;
                    message += `Splitter Desb.: ${segment.splitterHub}\n`;
                    message += `Sinal Saída: ${segment.sinalSaidaHub} dBm\n`;
                    message += `Splitter CTO: ${segment.splitterCto}\n`;
                    message += `*Sinal Final CTO:* ${segment.sinalFinalCto || '---'} dBm\n`;
                    if (segment.geo) {
                        message += `Geolocalização: ${segment.geo.lat}, ${segment.geo.lon}\n`;
                    }
                    message += `\n`;
                }
            });

            const shareData = { title: `Relatório de CTOs`, text: message };
            if (navigator.share) {
                try { await navigator.share(shareData); } catch (err) { console.error('Erro ao compartilhar:', err); }
            } else {
                showModal('Compartilhamento Indisponível', 'O seu navegador não suporta a função de compartilhamento. Pode copiar o texto manualmente.');
            }
        }
        
        function saveProject() {
            const suggestedName = projectName || new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
            const fileName = prompt("Digite o nome do arquivo para salvar o projeto:", suggestedName);
            
            if (fileName === null) return; // User cancelled
            
            projectName = fileName; // Update project name
            
            const projectData = { 
                version: "1.0", 
                projectName,
                oltPower, 
                googleMapsUrl, 
                networkSegments, 
                balancedConfig, 
                balancedNetworkCtos
            };

            const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = Object.assign(document.createElement('a'), {
                href: url,
                download: `${fileName.replace(/[^a-z0-9]/gi, '_') || 'projeto_cto'}.json`
            });
            document.body.appendChild(a).click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            updateUIWithLoadedData(); // Refresh title
            showModal("Projeto Salvo", `O projeto "${fileName}" foi salvo com sucesso!`);
        }
    
        function loadProject(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    projectName = data.projectName || '';
                    oltPower = data.oltPower || 7.00;
                    googleMapsUrl = data.googleMapsUrl || '';
                    networkSegments = data.networkSegments || [];
                    balancedConfig = data.balancedConfig || { primarySplitter: '1:8' };
                    balancedNetworkCtos = data.balancedNetworkCtos || [];
                    
                    event.target.value = ''; // Reset file input
                    updateUIWithLoadedData();
                    showModal("Projeto Carregado", `O projeto "${projectName}" foi carregado com sucesso!`);
                } catch (error) {
                    showModal("Erro ao Carregar", "O arquivo do projeto pode estar corrompido ou em formato inválido.");
                    console.error("Load project error:", error);
                }
            };
            reader.readAsText(file);
        }

        function addCto() {
            const lastSegment = networkSegments.length > 0 ? networkSegments[networkSegments.length - 1] : { colorGroup: -1 };
            networkSegments.push({
                splitterHub: 'Ausente',
                splitterCto: 'Ausente', 
                distance: 0,
                spliceCount: 0,
                geo: null,
                description: '',
                colorGroup: (lastSegment.colorGroup + 1) % 12
            });
            recalculateUnbalanced();
        }

        function removeCto(index) {
            if (networkSegments.length > 0) {
                networkSegments.splice(index, 1);
                recalculateUnbalanced();
            }
        }

        function addBalancedCto() {
            const lastCto = balancedNetworkCtos.length > 0 ? balancedNetworkCtos[balancedNetworkCtos.length - 1] : { colorGroup: -1 };
            const newColorGroup = lastCto ? (lastCto.colorGroup + 1) % 12 : 0;
            balancedNetworkCtos.push({ 
                distance: 0, 
                spliceCount: 0, 
                geo: null, 
                description: '', 
                colorGroup: newColorGroup,
                splitterCto: '1:8'
            });
            recalculateBalanced();
        }

        function removeBalancedCto(index) {
            if (balancedNetworkCtos.length > 0) {
                balancedNetworkCtos.splice(index, 1);
                recalculateBalanced();
            }
        }
        
        function printCtoReport() {
            document.body.classList.add('cto-print-mode');
            
            const activePanel = document.getElementById(`tab-panel-${activeTab}`);
            if(activePanel) activePanel.classList.add('active-for-print');

            window.print();
            
            document.body.classList.remove('cto-print-mode');
             if(activePanel) activePanel.classList.remove('active-for-print');
        }

        function downloadFieldReport() {
             const date = new Date().toLocaleDateString('pt-BR');
            let ctoCardsHtml = '';
            let networkTitle = '';

            if (activeTab === 'desbalanceada') {
                networkTitle = 'Parâmetros da Rede Desbalanceada';
                networkSegments.forEach((cto, index) => {
                    const title = `CTO-${String(index + 1).padStart(2, '0')}`;
                    const selectedColor = FIBER_COLORS[cto.colorGroup || 0];
                    const geoText = cto.geo ? `${cto.geo.lat.toFixed(5)}, ${cto.geo.lon.toFixed(5)}` : 'N/A';
                    const googleMapsLink = cto.geo ? `<a href="https://www.google.com/maps?q=${cto.geo.lat},${cto.geo.lon}" target="_blank" style="color: #3b82f6; text-decoration: underline;">Ver no Mapa</a>` : 'N/A';
                    
                    ctoCardsHtml += `
    <div style="border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <h3 style="font-size: 1.125rem; font-weight: bold; margin-bottom: 0.5rem;">${title} (${selectedColor.name})</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div><strong>Distância:</strong> ${cto.distance || 0} m</div>
            <div><strong>Nº de Fusões:</strong> ${cto.spliceCount || 0}</div>
            <div><strong>Splitter Desb.:</strong> ${cto.splitterHub || 'N/A'}</div>
            <div><strong>Splitter CTO:</strong> ${cto.splitterCto || 'N/A'}</div>
            <div><strong>Sinal Final Estimado:</strong> <span style="font-weight: bold;">${cto.sinalFinalCto || '---'} dBm</span></div>
            <div><strong>Sinal Medido:</strong> _________________ dBm</div>
            <div><strong>Geolocalização:</strong> ${geoText} ${googleMapsLink}</div>
        </div>
        <div style="margin-top: 1rem;">
            <strong>Notas de Campo:</strong>
            <p style="margin-top: 0.25rem; border-bottom: 1px solid #d1d5db; padding-bottom: 0.25rem;">${cto.description || '________________________________________________'}</p>
        </div>
    </div>`;
                });
            } else { // Rede Balanceada
                networkTitle = 'Parâmetros da Rede Balanceada';
                 balancedNetworkCtos.forEach((cto, index) => {
                    const title = `CTO Bal.-${String(index + 1).padStart(2, '0')}`;
                    const selectedColor = FIBER_COLORS[cto.colorGroup || 0];
                    const geoText = cto.geo ? `${cto.geo.lat.toFixed(5)}, ${cto.geo.lon.toFixed(5)}` : 'N/A';
                    const googleMapsLink = cto.geo ? `<a href="https://www.google.com/maps?q=${cto.geo.lat},${cto.geo.lon}" target="_blank" style="color: #3b82f6; text-decoration: underline;">Ver no Mapa</a>` : 'N/A';
                    
                    ctoCardsHtml += `
    <div style="border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <h3 style="font-size: 1.125rem; font-weight: bold; margin-bottom: 0.5rem;">${title} (${selectedColor.name})</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div><strong>Distância:</strong> ${cto.distance || 0} m</div>
            <div><strong>Nº de Fusões:</strong> ${cto.spliceCount || 0}</div>
            <div><strong>Splitter Primário:</strong> ${balancedConfig.primarySplitter || 'N/A'}</div>
            <div><strong>Splitter CTO:</strong> ${cto.splitterCto || 'N/A'}</div>
            <div><strong>Sinal Final Estimado:</strong> <span style="font-weight: bold;">${cto.sinalFinal || '---'} dBm</span></div>
            <div><strong>Sinal Medido:</strong> _________________ dBm</div>
            <div><strong>Geolocalização:</strong> ${geoText} ${googleMapsLink}</div>
        </div>
        <div style="margin-top: 1rem;">
            <strong>Notas de Campo:</strong>
            <p style="margin-top: 0.25rem; border-bottom: 1px solid #d1d5db; padding-bottom: 0.25rem;">${cto.description || '________________________________________________'}</p>
        </div>
    </div>`;
                });
            }


            const reportContent = `
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório de Campo</title>
    <style>
        body { font-family: sans-serif; background-color: #f4f4f9; color: #1f2937; padding: 2rem; }
        .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1, h2 { border-bottom: 1px solid #ddd; padding-bottom: 8px; margin-bottom: 16px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Relatório de Campo</h1>
        <p>Gerado em: ${date}</p>
        <h2>Configurações Gerais</h2>
        <p><strong>Potência OLT:</strong> ${oltPower.toFixed(2)} dBm</p>
        <p><strong>Mapa do Projeto:</strong> ${googleMapsUrl ? `<a href="${googleMapsUrl}" target="_blank">${googleMapsUrl}</a>` : 'N/A'}</p>
        
        <h2>${networkTitle}</h2>
        ${ctoCardsHtml}
    </div>
</body>
</html>`;

            const blob = new Blob([reportContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `relatorio_de_campo_${activeTab}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        window.onload = function() {
            updateUIWithLoadedData();
        };

        // --- Dropdown Menu Logic ---
        const menuButton = document.getElementById('project-menu-button');
        const menu = document.getElementById('project-menu');

        menuButton.addEventListener('click', () => {
            menu.classList.toggle('hidden');
        });

        // Close dropdown if clicking outside
        window.addEventListener('click', function(e) {
            if (!menuButton.contains(e.target) && !menu.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });
    </script>
</body>
</html>

